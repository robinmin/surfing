---
import type { CollectionEntry } from 'astro:content'
import ReadingKeyboardNavigation from '~/components/common/ReadingKeyboardNavigation.astro'
import BackToTopButton from '~/components/ui/BackToTopButton.astro'
import PageHeader from '~/components/ui/PageHeader.astro'
import ReadingProgress from '~/components/ui/ReadingProgress.astro'
import TableOfContents from '~/components/ui/TableOfContents.astro'
import Announcement from '~/components/widgets/Announcement.astro'
import Footer from '~/components/widgets/Footer.astro'
import Header from '~/components/widgets/Header.astro'
import Layout from '~/layouts/Layout.astro'
import { footerData, headerData } from '~/navigation'
import type { MetaData } from '~/types'

export interface Props {
  metadata?: MetaData
  document: CollectionEntry<'documents'>
}

const { metadata, document } = Astro.props
const { data: frontmatter } = document

// Determine if we should preserve the original HTML structure
const preserveStyles = frontmatter.preserveStyles !== false
const hasCustomCSS = frontmatter.customCSS && frontmatter.customCSS.trim().length > 0
const hasCustomJS = frontmatter.customJS && frontmatter.customJS.trim().length > 0
---

<Layout metadata={metadata}>
  <!-- Reading Progress Bar -->
  <ReadingProgress />

  <!-- Keyboard Navigation -->
  <ReadingKeyboardNavigation />

  <!-- Table of Contents -->
  <TableOfContents />

  <!-- Back to Top Button -->
  <BackToTopButton />

  <!-- Custom CSS injection -->
  {hasCustomCSS && <style set:html={frontmatter.customCSS} />}

  <slot name="announcement">
    <Announcement />
  </slot>

  <slot name="header">
    <Header {...headerData} isSticky showRssFeed showToggleTheme />
  </slot>

  <main>
    <!-- Document Header -->
    <section class="px-4 py-8 sm:px-6 mx-auto lg:px-8 lg:py-12 max-w-6xl">
      <div class="mb-8">
        <!-- Content Type Badge -->
        <div class="mb-4">
          <span
            class={`inline-block px-3 py-1 text-sm rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200`}
          >
            {
              frontmatter.contentType === 'legacy'
                ? 'Legacy Document'
                : frontmatter.contentType === 'template'
                  ? 'Template'
                  : frontmatter.contentType === 'snippet'
                    ? 'Code Snippet'
                    : 'HTML Document'
            }
          </span>
        </div>

        <!-- Page Header with Metadata -->
        <PageHeader
          title={frontmatter.title || ''}
          description={frontmatter.description}
          publishDate={frontmatter.publishDate}
          updateDate={frontmatter.updateDate}
          tags={frontmatter.tags}
          author={frontmatter.author}
        />
      </div>
    </section>

    <!-- Document Content -->
    <section class="px-4 pb-16 sm:px-6 mx-auto lg:px-8 lg:pb-20 max-w-6xl">
      <div class={`${preserveStyles ? 'document-content-preserved' : 'document-content-styled'} reading-text`}>
        <slot />
      </div>
    </section>
  </main>

  <slot name="footer">
    <Footer {...footerData} />
  </slot>

  <!-- Custom JavaScript injection -->
  {hasCustomJS && <script is:inline set:html={frontmatter.customJS} />}
</Layout>

<style>
  /* Styled content - applies site's design system */
  .document-content-styled {
    @apply prose prose-lg max-w-none dark:prose-invert;
    @apply prose-headings:font-heading prose-headings:leading-tight;
    @apply prose-a:text-blue-600 dark:prose-a:text-blue-400;
    @apply prose-code:bg-gray-100 dark:prose-code:bg-gray-800;
    @apply prose-pre:bg-gray-900 prose-pre:text-gray-100;
  }

  /* Preserved content - minimal styling to preserve original appearance */
  .document-content-preserved {
    /* Reset some base styles that might interfere */
    line-height: inherit;
    color: inherit;
    font-family: inherit;
  }

  /* Ensure custom styles don't break the layout */
  .document-content-preserved * {
    max-width: 100%;
  }

  /* Handle responsive images */
  .document-content-preserved img {
    max-width: 100%;
    height: auto;
  }

  /* Ensure tables are responsive */
  .document-content-preserved table {
    width: 100%;
    overflow-x: auto;
    display: block;
    white-space: nowrap;
  }

  .document-content-preserved table tbody,
  .document-content-preserved table thead,
  .document-content-preserved table tr {
    display: table;
    width: 100%;
  }

  /* Dark mode compatibility for preserved content */
  @media (prefers-color-scheme: dark) {
    .document-content-preserved {
      /* Only apply if no custom styles are provided */
      color-scheme: dark;
    }
  }
</style>
