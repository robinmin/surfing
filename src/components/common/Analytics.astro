---
import { ANALYTICS } from 'astrowind:config';
import { loadConfig } from '../../../vendor/integration/utils/loadConfig';

// Load configuration to check if cookie consent is enabled
const config = (await loadConfig('./src/config.yaml')) as Record<string, unknown>;
const isCookieConsentEnabled =
    (config?.cookieConsent as Record<string, boolean | undefined>)?.enabled ?? true;

// Prepare Google Analytics scripts as strings to avoid Prettier parsing issues
const gtagScript = `
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }

  gtag('consent', 'default', {
    ad_storage: 'denied',
    ad_user_data: 'denied',
    ad_personalization: 'denied',
    analytics_storage: 'granted',
    functionality_storage: 'granted',
    personalization_storage: 'denied',
    security_storage: 'granted',
    wait_for_update: 500,
  });

  const script = document.createElement('script');
  script.async = true;
  script.src = 'https://www.googletagmanager.com/gtag/js?id=' + gtag_id;
  document.head.appendChild(script);

  script.onload = function() {
    gtag('js', new Date());
    gtag('config', gtag_id, {
      anonymize_ip: true,
      allow_google_signals: false,
      allow_ad_personalization_signals: false
    });
  };
`;

const consentScript = `
  // Wait for CookieConsent to be available
  window.addEventListener('cc:onFirstConsent', function () {
    const acceptedCategories = (window.CC?.getCookieData?.()?.categories) || [];
    updateConsent(acceptedCategories);
  });

  window.addEventListener('cc:onConsent', function (event) {
    const acceptedCategories = (event.detail?.cookie?.categories) || [];
    updateConsent(acceptedCategories);
  });

  function updateConsent(categories) {
    // Google Analytics consent
    if (window.gtag) {
      const consentUpdate = {
        functionality_storage: 'granted',
        security_storage: 'granted',
        analytics_storage: 'denied',
        ad_storage: 'denied',
        ad_user_data: 'denied',
        ad_personalization: 'denied'
      };

      // Analytics consent
      if (categories.includes('analytics')) {
        consentUpdate.analytics_storage = 'granted';
      }

      // Marketing consent
      if (categories.includes('marketing')) {
        consentUpdate.ad_storage = 'granted';
        consentUpdate.ad_user_data = 'granted';
        consentUpdate.ad_personalization = 'granted';
      }

      window.gtag('consent', 'update', consentUpdate);
    }

    // Google Ads consent
    if (categories.includes('marketing')) {
      window.__googleAdsConsentGranted = true;
      window.dispatchEvent(new CustomEvent('googleads:consent', {
        detail: { granted: true }
      }));
    } else {
      window.__googleAdsConsentGranted = false;
      window.dispatchEvent(new CustomEvent('googleads:consent', {
        detail: { granted: false }
      }));
    }
  }
`;

const clarityScript = `
  (function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
  })(window, document, "clarity", "script", clarity_id);
`;
---

{
  ANALYTICS?.vendors?.googleAnalytics?.id && isCookieConsentEnabled && (
    <Fragment>
      <script
        is:inline
        define:vars={{ gtag_id: ANALYTICS.vendors.googleAnalytics.id }}
        set:html={gtagScript}
      />
      <script is:inline set:html={consentScript} />
    </Fragment>
  )
}

{
  ANALYTICS?.vendors?.microsoftClarity?.id && (
    <script
      is:inline
      define:vars={{ clarity_id: ANALYTICS.vendors.microsoftClarity.id }}
      set:html={clarityScript}
    />
  )
}
