---
import { ADS } from 'astrowind:config';

const client = ADS.google?.client;

// Generate the inline script content at build time
const scriptContent = client
  ? `
(function() {
  if (typeof window === 'undefined') return;

  const client = ${JSON.stringify(client)};
  if (!client) return;

  const ADS_SCRIPT_URL = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=' + client;
  const SLOT_SELECTOR = 'ins.adsbygoogle';
  const PUSHED_ATTR = 'data-adsbygoogle-status';

  const pushExistingSlots = function() {
    const adsQueue = (window.adsbygoogle = window.adsbygoogle || []);
    document.querySelectorAll(SLOT_SELECTOR + ':not([' + PUSHED_ATTR + '])').forEach(function(slot) {
      slot.setAttribute(PUSHED_ATTR, '');
      adsQueue.push({});
    });
  };

  const loadAdsenseScript = function() {
    // Check if script already exists by URL
    const existingScript = document.querySelector('script[src^="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"]');
    if (existingScript) {
      if (window.__googleAdsScriptLoaded) {
        pushExistingSlots();
      } else {
        existingScript.addEventListener('load', pushExistingSlots, { once: true });
      }
      return;
    }

    const script = document.createElement('script');
    script.src = ADS_SCRIPT_URL;
    script.async = true;
    script.crossOrigin = 'anonymous';
    script.addEventListener('load', function() {
      window.__googleAdsScriptLoaded = true;
      pushExistingSlots();
    });
    document.head.appendChild(script);
  };

  const hasConsent = function() {
    return Boolean(window && window.__googleAdsConsentGranted);
  };

  const init = function() {
    loadAdsenseScript();
  };

  pushExistingSlots();

  if (hasConsent()) {
    init();
  } else {
    const handler = function(event) {
      const detail = event && event.detail;
      if (detail && detail.granted) {
        init();
        window.removeEventListener('googleads:consent', handler);
      }
    };

    window.addEventListener('googleads:consent', handler);
  }
})();
`.trim()
  : '';
---

{client && <script is:inline set:html={scriptContent} />}
