---
import { ADS } from 'astrowind:config';

const client = ADS.google?.client;

// Generate the inline script content at build time
const scriptContent = client
  ? `
(function() {
  if (typeof window === 'undefined') return;

  const client = ${JSON.stringify(client)};
  if (!client) return;

  const ADS_SCRIPT_SELECTOR = 'script[data-googleads="true"][data-google-ads-client="' + client + '"]';
  const SLOT_SELECTOR = 'ins.adsbygoogle';
  const PUSHED_ATTR = 'data-google-ads-pushed';

  const pushExistingSlots = function() {
    const adsQueue = (window.adsbygoogle = window.adsbygoogle || []);
    document.querySelectorAll(SLOT_SELECTOR + ':not([' + PUSHED_ATTR + '="true"])').forEach(function(slot) {
      slot.setAttribute(PUSHED_ATTR, 'true');
      adsQueue.push({});
    });
  };

  const loadAdsenseScript = function() {
    const existingScript = document.querySelector(ADS_SCRIPT_SELECTOR);
    if (existingScript) {
      if (window.__googleAdsScriptLoaded) {
        pushExistingSlots();
      } else {
        existingScript.addEventListener('load', pushExistingSlots, { once: true });
      }
      return;
    }

    const script = document.createElement('script');
    script.src = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=' + client;
    script.async = true;
    script.setAttribute('crossorigin', 'anonymous');
    script.dataset.googleads = 'true';
    script.dataset.googleAdsClient = client;
    script.addEventListener('load', function() {
      window.__googleAdsScriptLoaded = true;
      pushExistingSlots();
    });
    document.head.appendChild(script);
    pushExistingSlots();
  };

  const hasConsent = function() {
    return Boolean(window && window.__googleAdsConsentGranted);
  };

  const init = function() {
    loadAdsenseScript();
  };

  pushExistingSlots();

  if (hasConsent()) {
    init();
  } else {
    const handler = function(event) {
      const detail = event && event.detail;
      if (detail && detail.granted) {
        init();
        window.removeEventListener('googleads:consent', handler);
      }
    };

    window.addEventListener('googleads:consent', handler);
  }
})();
`.trim()
  : '';
---

{client && <script is:inline set:html={scriptContent} />}
