---
// Access environment variables from process.env (set by GitHub Actions)
// Astro's import.meta.env only reads from .env files, not from process.env
const config = {
  authority: process.env.PUBLIC_ZITADEL_AUTHORITY,
  clientId: process.env.PUBLIC_ZITADEL_CLIENT_ID,
  redirectUri: process.env.PUBLIC_ZITADEL_REDIRECT_URI,
  postLogoutUri: process.env.PUBLIC_ZITADEL_POST_LOGOUT_URI,
  orgId: process.env.PUBLIC_ZITADEL_ORG_ID,
  idpGoogle: process.env.PUBLIC_ZITADEL_IDP_GOOGLE,
  idpGithub: process.env.PUBLIC_ZITADEL_IDP_GITHUB,
  idpApple: process.env.PUBLIC_ZITADEL_IDP_APPLE,
  idpMicrosoft: process.env.PUBLIC_ZITADEL_IDP_MICROSOFT,
};
---

<!-- Inline script to set global config (can't use imports) -->
<script is:inline define:vars={{ config }}>
  window.__OIDC_CONFIG__ = config;
</script>

<!-- Module script to initialize OIDC (can use imports) -->
<script>
  import { initOIDC } from "~/lib/turnstile-client";

  // Get config from global variable set by inline script
  const config = window.__OIDC_CONFIG__;

  if (config) {
    initOIDC({
      authority: config.authority,
      clientId: config.clientId,
      redirectUri:
        config.redirectUri || window.location.origin + "/auth/callback",
      postLogoutUri: config.postLogoutUri || window.location.origin,
      orgId: config.orgId,
      idpHints: {
        google: config.idpGoogle || "",
        github: config.idpGithub || "",
        apple: config.idpApple || "",
        microsoft: config.idpMicrosoft || "",
      },
    });

    console.log("✅ OIDC Client initialized");
  } else {
    console.error("❌ OIDC config not found");
  }
</script>
