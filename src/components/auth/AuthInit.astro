---
// Access environment variables in the frontmatter (server-side)
// Astro replaces import.meta.env at build time here
const config = {
  authority: import.meta.env.PUBLIC_ZITADEL_AUTHORITY,
  clientId: import.meta.env.PUBLIC_ZITADEL_CLIENT_ID,
  redirectUri: import.meta.env.PUBLIC_ZITADEL_REDIRECT_URI,
  postLogoutUri: import.meta.env.PUBLIC_ZITADEL_POST_LOGOUT_URI,
  orgId: import.meta.env.PUBLIC_ZITADEL_ORG_ID,
  idpGoogle: import.meta.env.PUBLIC_ZITADEL_IDP_GOOGLE,
  idpGithub: import.meta.env.PUBLIC_ZITADEL_IDP_GITHUB,
  idpApple: import.meta.env.PUBLIC_ZITADEL_IDP_APPLE,
  idpMicrosoft: import.meta.env.PUBLIC_ZITADEL_IDP_MICROSOFT,
};
---

<!-- Inline script to set global config (can't use imports) -->
<script is:inline define:vars={{ config }}>
  window.__OIDC_CONFIG__ = config;
</script>

<!-- Module script to initialize OIDC (can use imports) -->
<script>
  import { initOIDC } from "~/lib/turnstile-client";

  // Get config from global variable set by inline script
  const config = window.__OIDC_CONFIG__;

  if (config) {
    initOIDC({
      authority: config.authority,
      clientId: config.clientId,
      redirectUri:
        config.redirectUri || window.location.origin + "/auth/callback",
      postLogoutUri: config.postLogoutUri || window.location.origin,
      orgId: config.orgId,
      idpHints: {
        google: config.idpGoogle || "",
        github: config.idpGithub || "",
        apple: config.idpApple || "",
        microsoft: config.idpMicrosoft || "",
      },
    });

    console.log("✅ OIDC Client initialized");
  } else {
    console.error("❌ OIDC config not found");
  }
</script>
