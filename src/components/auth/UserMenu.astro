---
/**
 * UserMenu Component
 * Popup menu for authenticated users with profile and sign out options
 */
import { Icon } from 'astro-icon/components';
import { t, getCurrentLanguage, type SupportedLanguage } from '~/i18n';

export interface Props {
  className?: string;
}

const { className = '' } = Astro.props;
const lang = (Astro.currentLocale || getCurrentLanguage()) as SupportedLanguage;
---

<div
  class:list={[
    'user-menu absolute top-full mt-2 right-0',
    'bg-white dark:bg-gray-800',
    'border border-gray-200 dark:border-gray-700',
    'rounded-xl shadow-2xl',
    'min-w-[280px] max-w-[320px]', // Increased width for better content fit
    'opacity-0 invisible',
    'transition-all duration-200 ease-in-out',
    'z-[60]', // Higher z-index to ensure it's above everything
    className,
  ]}
  data-user-menu
>
  <div class="py-2">
    <!-- User info section with provider logo -->
    <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center gap-3 mb-2">
        <!-- Auth provider logo -->
        <div class="auth-provider-logo flex-shrink-0" data-provider-logo>
          <Icon name="tabler:brand-google" class="h-5 w-5 text-blue-600 dark:text-blue-400" />
        </div>
        <div class="flex-1 min-w-0">
          <div class="text-sm font-semibold text-gray-900 dark:text-gray-100 truncate" data-user-name>Loading...</div>
          <div class="text-xs text-gray-500 dark:text-gray-400 truncate" data-user-email>Loading...</div>
        </div>
      </div>
      <div class="text-xs text-gray-400 dark:text-gray-500 italic">{t('auth.signedInAs', lang)}</div>
    </div>

    <!-- Sign out button -->
    <button
      type="button"
      class="user-menu-signout w-full flex items-center gap-3 px-4 py-3 text-left hover:bg-red-50 dark:hover:bg-red-900/20 transition-all duration-150 rounded-lg mx-2 my-2 border border-transparent hover:border-red-200 dark:hover:border-red-800 group"
    >
      <Icon
        name="tabler:logout"
        class="h-5 w-5 text-red-600 dark:text-red-400 flex-shrink-0 group-hover:scale-110 transition-transform duration-150"
      />
      <span
        class="text-sm font-medium text-red-700 dark:text-red-300 group-hover:text-red-800 dark:group-hover:text-red-200 transition-colors duration-150"
        >{t('auth.signOut', lang)}</span
      >
    </button>
  </div>
</div>

<style>
  .user-menu.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(-4px); /* Add subtle upward animation */
  }

  /* Enhanced arrow pointing up to avatar */
  .user-menu::before {
    content: '';
    position: absolute;
    top: -7px;
    right: 20px;
    width: 14px;
    height: 14px;
    background: inherit;
    border-right: 1px solid;
    border-bottom: 1px solid;
    border-color: inherit;
    transform: rotate(-45deg);
    z-index: -1;
  }

  /* Provider logo styling */
  .auth-provider-logo {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: rgba(59, 130, 246, 0.1); /* Blue background for Google */
    border: 1px solid rgba(59, 130, 246, 0.2);
  }

  .dark .auth-provider-logo {
    background: rgba(59, 130, 246, 0.2);
    border-color: rgba(59, 130, 246, 0.3);
  }

  /* Apple provider logo styling */
  .auth-provider-logo[data-provider='apple'] {
    background: rgba(0, 0, 0, 0.1);
    border-color: rgba(0, 0, 0, 0.2);
  }

  .dark .auth-provider-logo[data-provider='apple'] {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
  }

  /* Responsive adjustments */
  @media (max-width: 640px) {
    .user-menu {
      right: 0;
      min-width: 260px;
      max-width: 300px;
    }

    .user-menu::before {
      right: 16px;
    }
  }

  /* Prevent text overflow */
  .user-menu {
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
  }
</style>
