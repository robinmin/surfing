---
import { Icon } from 'astro-icon/components';
import Button from '~/components/ui/Button.astro';
import Headline from '~/components/ui/Headline.astro';
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import Hero from '~/components/widgets/Hero.astro';
import { getCurrentLanguage, t } from '~/i18n';
import Layout from '~/layouts/PageLayout.astro';

const lang = getCurrentLanguage();

const metadata = {
    title: t('pages.pricing.title', lang),
    description: t('pages.pricing.description', lang),
};

// Pricing tier data
const pricingTiers = [
    {
        name: 'free',
        nameKey: 'pages.pricing.tiers.free.name',
        descriptionKey: 'pages.pricing.tiers.free.description',
        price: { monthly: 0, yearly: 0, lifetime: 0 },
        features: [
            { key: 'pages.pricing.features.publicArticles', included: true },
            { key: 'pages.pricing.features.cheatsheetViewing', included: true },
            { key: 'pages.pricing.features.premiumArticles', included: false },
            { key: 'pages.pricing.features.cheatsheetDownloads', included: false },
            { key: 'pages.pricing.features.priorityAccess', included: false },
            { key: 'pages.pricing.features.apiAccess', included: false },
            { key: 'pages.pricing.features.exclusiveContent', included: false },
        ],
        cta: { textKey: 'pages.pricing.cta.getStarted' },
        highlighted: false,
    },
    {
        name: 'standard',
        nameKey: 'pages.pricing.tiers.standard.name',
        descriptionKey: 'pages.pricing.tiers.standard.description',
        price: { monthly: 5, yearly: 50, lifetime: 150 },
        features: [
            { key: 'pages.pricing.features.publicArticles', included: true },
            { key: 'pages.pricing.features.cheatsheetViewing', included: true },
            { key: 'pages.pricing.features.premiumArticles', included: true },
            { key: 'pages.pricing.features.cheatsheetDownloads', included: true },
            { key: 'pages.pricing.features.priorityAccess', included: false },
            { key: 'pages.pricing.features.apiAccess', included: false },
            { key: 'pages.pricing.features.exclusiveContent', included: false },
        ],
        cta: { textKey: 'pages.pricing.cta.subscribe', action: 'checkout' },
        highlighted: true,
        ribbonKey: 'pages.pricing.popular',
    },
    {
        name: 'premium',
        nameKey: 'pages.pricing.tiers.premium.name',
        descriptionKey: 'pages.pricing.tiers.premium.description',
        price: { monthly: 15, yearly: 150, lifetime: 400 },
        features: [
            { key: 'pages.pricing.features.publicArticles', included: true },
            { key: 'pages.pricing.features.cheatsheetViewing', included: true },
            { key: 'pages.pricing.features.premiumArticles', included: true },
            { key: 'pages.pricing.features.cheatsheetDownloads', included: true },
            { key: 'pages.pricing.features.priorityAccess', included: true },
            { key: 'pages.pricing.features.apiAccess', included: true },
            { key: 'pages.pricing.features.exclusiveContent', included: true },
        ],
        cta: { textKey: 'pages.pricing.cta.goPremium', action: 'checkout' },
        highlighted: false,
    },
];

// Billing cycle options
const billingCycles = [
    { id: 'monthly', labelKey: 'pages.pricing.billing.monthly' },
    {
        id: 'yearly',
        labelKey: 'pages.pricing.billing.yearly',
        savingsKey: 'pages.pricing.billing.yearlySavings',
    },
    { id: 'lifetime', labelKey: 'pages.pricing.billing.lifetime' },
];
---

<Layout metadata={metadata}>
  <Hero>
    <Fragment slot="bg">
      <div
        class="absolute inset-0 bg-cover bg-center bg-no-repeat opacity-50 dark:opacity-40"
        style="background-image: url(/assets/pricing_hero.png)"
      >
      </div>
    </Fragment>
    <Fragment slot="title">
      <span data-i18n-key="pages.pricing.heroTitle"
        >{t("pages.pricing.heroTitle", lang)}</span
      >
    </Fragment>

    <Fragment slot="subtitle">
      <span data-i18n-key="pages.pricing.heroSubtitle"
        >{t("pages.pricing.heroSubtitle", lang)}</span
      >
    </Fragment>
  </Hero>

  <WidgetWrapper id="pricing" containerClass="max-w-7xl mx-auto">
    <Headline
      title={t("pages.pricing.choosePlan", lang)}
      subtitle={t("pages.pricing.choosePlanSubtitle", lang)}
      titleI18n="pages.pricing.choosePlan"
      subtitleI18n="pages.pricing.choosePlanSubtitle"
    />

    <!-- Billing Cycle Toggle -->
    <div class="flex justify-center mb-10">
      <div
        class="inline-flex rounded-full bg-gray-100 dark:bg-slate-800 p-1"
        role="tablist"
      >
        {
          billingCycles.map((cycle, index) => (
            <button
              type="button"
              role="tab"
              data-billing-cycle={cycle.id}
              class:list={[
                "billing-cycle-btn px-4 py-2 text-sm font-medium rounded-full transition-all duration-200",
                index === 0
                  ? "bg-primary text-white"
                  : "text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white",
              ]}
              aria-selected={index === 0 ? "true" : "false"}
              data-i18n-key={cycle.labelKey}
            >
              {t(cycle.labelKey, lang)}
              {cycle.savingsKey && (
                <span
                  class="ml-1 text-xs text-green-500"
                  data-i18n-key={cycle.savingsKey}
                >
                  {t(cycle.savingsKey, lang)}
                </span>
              )}
            </button>
          ))
        }
      </div>
    </div>

    <!-- Pricing Cards -->
    <div class="flex items-stretch justify-center">
      <div
        class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3"
      >
        {
          pricingTiers.map((tier) => (
            <div class="relative flex w-full max-w-sm flex-col intersect-once motion-safe:md:intersect:animate-fade motion-safe:md:opacity-0 intersect-quarter">
              <div
                class:list={[
                  "rounded-lg backdrop-blur-md border bg-white/60 dark:bg-slate-900/60 shadow-lg px-6 py-8 flex w-full flex-col justify-between text-center h-full transition-all duration-300 hover:shadow-xl hover:-translate-y-1 mx-auto",
                  tier.highlighted
                    ? "border-primary ring-2 ring-primary/50 relative transform scale-105 z-10"
                    : "border-gray-200 dark:border-gray-700",
                ]}
              >
                {tier.highlighted && tier.ribbonKey && (
                  <div class="absolute right-[-5px] 2xl:right-[-8px] rtl:right-auto rtl:left-[-8px] rtl:2xl:left-[-10px] top-[-5px] 2xl:top-[-10px] z-[1] h-[100px] w-[100px] overflow-hidden text-right">
                    <span
                      class="absolute top-[19px] right-[-21px] rtl:right-auto rtl:left-[-21px] block w-full rotate-45 rtl:-rotate-45 bg-primary text-center text-[10px] font-bold uppercase leading-5 text-white shadow-[0_3px_10px_-5px_rgba(0,0,0,0.3)] before:absolute before:left-0 before:top-full before:z-[-1] before:border-[3px] before:border-r-transparent before:border-b-transparent before:border-l-primary before:border-t-primary before:content-[''] after:absolute after:right-0 after:top-full after:z-[-1] after:border-[3px] after:border-l-transparent after:border-b-transparent after:border-r-primary after:border-t-primary after:content-['']"
                      data-i18n-key={tier.ribbonKey}
                    >
                      {t(tier.ribbonKey, lang)}
                    </span>
                  </div>
                )}

                <div class="px-2 py-0">
                  <h3
                    class="text-center text-xl font-semibold uppercase leading-6 tracking-wider mb-2"
                    data-i18n-key={tier.nameKey}
                  >
                    {t(tier.nameKey, lang)}
                  </h3>
                  <p
                    class="font-light sm:text-lg text-gray-600 dark:text-slate-400"
                    data-i18n-key={tier.descriptionKey}
                  >
                    {t(tier.descriptionKey, lang)}
                  </p>

                  <div class="my-8">
                    <div class="flex items-center justify-center text-center mb-1">
                      <span class="text-3xl">$</span>
                      <span
                        class="text-6xl font-extrabold price-amount tracking-tight"
                        data-price-monthly={tier.price.monthly}
                        data-price-yearly={tier.price.yearly}
                        data-price-lifetime={tier.price.lifetime}
                      >
                        {tier.price.monthly}
                      </span>
                    </div>
                    <span
                      class="text-base leading-6 lowercase text-gray-600 dark:text-slate-400 price-period"
                      data-period-monthly={t(
                        "pages.pricing.period.monthly",
                        lang,
                      )}
                      data-period-yearly={t(
                        "pages.pricing.period.yearly",
                        lang,
                      )}
                      data-period-lifetime={t(
                        "pages.pricing.period.lifetime",
                        lang,
                      )}
                    >
                      {t("pages.pricing.period.monthly", lang)}
                    </span>
                  </div>

                  <ul class="my-8 md:my-10 space-y-2 text-left">
                    {tier.features.map((feature) => (
                      <li class="mb-1.5 flex items-start space-x-3 leading-7">
                        <div
                          class:list={[
                            "rounded-full mt-1",
                            feature.included
                              ? "bg-primary"
                              : "bg-gray-300 dark:bg-gray-600",
                          ]}
                        >
                          <Icon
                            name={
                              feature.included ? "tabler:check" : "tabler:x"
                            }
                            class="w-5 h-5 font-bold p-1 text-white"
                          />
                        </div>
                        <span
                          class:list={[
                            feature.included
                              ? ""
                              : "text-gray-400 dark:text-gray-500",
                          ]}
                          data-i18n-key={feature.key}
                        >
                          {t(feature.key, lang)}
                        </span>
                      </li>
                    ))}
                  </ul>
                </div>

                <div class="flex justify-center mt-auto">
                  {"href" in tier.cta && tier.cta.href ? (
                    <Button
                      variant={tier.highlighted ? "primary" : "secondary"}
                      href={tier.cta.href as string}
                      class="w-full"
                      data-i18n-key={tier.cta.textKey}
                    >
                      {t(tier.cta.textKey, lang)}
                    </Button>
                  ) : (
                    <button
                      type="button"
                      class:list={[
                        "checkout-btn w-full px-6 py-3 rounded-lg font-semibold transition-colors duration-200",
                        tier.name === "free"
                          ? "bg-green-600 text-white hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-800"
                          : tier.name === "standard"
                            ? "bg-primary text-white hover:bg-blue-700"
                            : tier.name === "premium"
                              ? "bg-gray-900 text-white hover:bg-black dark:bg-gray-100 dark:text-gray-900 dark:hover:bg-white"
                              : "bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white hover:bg-gray-300 dark:hover:bg-gray-600",
                      ]}
                      data-tier={tier.name}
                      data-i18n-key={tier.cta.textKey}
                    >
                      {t(tier.cta.textKey, lang)}
                    </button>
                  )}
                </div>
              </div>
            </div>
          ))
        }
      </div>
    </div>

    <!-- FAQ Section -->
    <div class="mt-16 max-w-3xl mx-auto">
      <h3
        class="text-2xl font-bold text-center mb-8"
        data-i18n-key="pages.pricing.faq.title"
      >
        {t("pages.pricing.faq.title", lang)}
      </h3>
      <div class="space-y-4">
        <details
          class="group border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-800/50 transition-colors duration-200"
        >
          <summary class="flex items-center justify-between p-4 cursor-pointer">
            <span class="font-medium" data-i18n-key="pages.pricing.faq.q1"
              >{t("pages.pricing.faq.q1", lang)}</span
            >
            <Icon
              name="tabler:chevron-down"
              class="w-5 h-5 transition-transform group-open:rotate-180"
            />
          </summary>
          <div
            class="px-4 pb-4 text-gray-600 dark:text-gray-400"
            data-i18n-key="pages.pricing.faq.a1"
          >
            {t("pages.pricing.faq.a1", lang)}
          </div>
        </details>
        <details
          class="group border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-800/50 transition-colors duration-200"
        >
          <summary class="flex items-center justify-between p-4 cursor-pointer">
            <span class="font-medium" data-i18n-key="pages.pricing.faq.q2"
              >{t("pages.pricing.faq.q2", lang)}</span
            >
            <Icon
              name="tabler:chevron-down"
              class="w-5 h-5 transition-transform group-open:rotate-180"
            />
          </summary>
          <div
            class="px-4 pb-4 text-gray-600 dark:text-gray-400"
            data-i18n-key="pages.pricing.faq.a2"
          >
            {t("pages.pricing.faq.a2", lang)}
          </div>
        </details>
        <details
          class="group border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-800/50 transition-colors duration-200"
        >
          <summary class="flex items-center justify-between p-4 cursor-pointer">
            <span class="font-medium" data-i18n-key="pages.pricing.faq.q3"
              >{t("pages.pricing.faq.q3", lang)}</span
            >
            <Icon
              name="tabler:chevron-down"
              class="w-5 h-5 transition-transform group-open:rotate-180"
            />
          </summary>
          <div
            class="px-4 pb-4 text-gray-600 dark:text-gray-400"
            data-i18n-key="pages.pricing.faq.a3"
          >
            {t("pages.pricing.faq.a3", lang)}
          </div>
        </details>
      </div>
    </div>
  </WidgetWrapper>
</Layout>

<script>
  import {
    getCurrentSession,
    signInRedirect,
    onUserLoaded,
    onUserUnloaded,
    initTracker,
    trackEvent,
    trackPageView,
  } from "~/lib/turnstile-client";
  import {
    PRICING_PAGE_VIEWED,
    PRICING_BILLING_CYCLE_CHANGED,
    PRICING_CTA_CLICKED,
    PRICING_CHECKOUT_INITIATED,
    PRICING_CHECKOUT_ERROR,
    PRICING_FAQ_EXPANDED,
    PRICING_FAQ_COLLAPSED,
    PRICING_PAGE_SCROLLED,
  } from "~/events";

  // State
  let currentCycle: "monthly" | "yearly" | "lifetime" = "monthly";

  // DOM Elements
  const billingCycleBtns = document.querySelectorAll(".billing-cycle-btn");
  const priceAmounts = document.querySelectorAll(".price-amount");
  const pricePeriods = document.querySelectorAll(".price-period");
  const checkoutBtns = document.querySelectorAll(".checkout-btn");

  // Billing Cycle Toggle
  billingCycleBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      const cycle = btn.getAttribute("data-billing-cycle") as
        | "monthly"
        | "yearly"
        | "lifetime";
      if (cycle === currentCycle) return;

      const previousCycle = currentCycle;
      currentCycle = cycle;

      // Track billing cycle change
      trackEvent(PRICING_BILLING_CYCLE_CHANGED, {
        previousCycle,
        newCycle: cycle,
      });

      // Update button states
      billingCycleBtns.forEach((b) => {
        b.classList.remove("bg-primary", "text-white");
        b.classList.add("text-gray-600", "dark:text-gray-400");
        b.setAttribute("aria-selected", "false");
      });
      btn.classList.add("bg-primary", "text-white");
      btn.classList.remove("text-gray-600", "dark:text-gray-400");
      btn.setAttribute("aria-selected", "true");

      // Update prices
      priceAmounts.forEach((el) => {
        const price = el.getAttribute(`data-price-${cycle}`);
        if (price) el.textContent = price;
      });

      // Update period text
      pricePeriods.forEach((el) => {
        const period = el.getAttribute(`data-period-${cycle}`);
        if (period) el.textContent = period;
      });
    });
  });

  // Helper: Get base classes for a tier (Default State)
  function getBaseClasses(tier: string) {
    const common =
      "checkout-btn w-full px-6 py-3 rounded-lg font-semibold transition-colors duration-200";
    switch (tier) {
      case "free":
        return `${common} bg-green-600 text-white hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-800`;
      case "standard":
        return `${common} bg-primary text-white hover:bg-blue-700`;
      case "premium":
        return `${common} bg-gray-900 text-white hover:bg-black dark:bg-gray-100 dark:text-gray-900 dark:hover:bg-white`;
      default:
        return `${common} bg-gray-200 text-gray-900`;
    }
  }

  // Function to Update UI based on Auth State
  async function updateButtonState() {
    const session = await getCurrentSession();
    const roles = session?.roles || [];

    // Default fallback: If logged in but no roles, treat as 'surfing-free'
    if (session && roles.length === 0) {
      roles.push("surfing-free");
    }

    console.debug("[Pricing] Updating button state. Roles:", roles);

    const buttons = document.querySelectorAll(".checkout-btn");
    buttons.forEach((btn) => {
      const tier = btn.getAttribute("data-tier");
      if (!tier) return;

      const targetRole = `surfing-${tier}`;
      const isCurrentPlan = roles.includes(targetRole);

      // Reset style to default base
      btn.className = getBaseClasses(tier);
      btn.removeAttribute("disabled");
      btn.classList.remove("opacity-70", "cursor-default");

      // Restore original text if not current plan
      if (!isCurrentPlan) {
        const textKey = btn.getAttribute("data-i18n-key");
        const textMap: Record<string, string> = {
          "pages.pricing.cta.getStarted": "Get Started",
          "pages.pricing.cta.subscribe": "Subscribe",
          "pages.pricing.cta.goPremium": "Go Premium",
        };
        if (textKey && textMap[textKey]) {
          btn.innerHTML = textMap[textKey];
        }
      }

      if (isCurrentPlan) {
        // Apply "Current Plan" style: Black text with GRAY background
        // Using specific gray colors and styling as requested
        btn.className =
          "checkout-btn w-full px-6 py-3 rounded-lg font-semibold transition-colors duration-200 bg-gray-200 text-gray-900 dark:bg-gray-700 dark:text-gray-100 opacity-70 cursor-default pointer-events-none";

        btn.innerHTML = `
            <span class="flex items-center justify-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M5 12l5 5l10 -10"></path>
              </svg>
              Current Plan
            </span>
          `;
        btn.setAttribute("disabled", "true");
      }
    });
  }

  // Action Button Handler
  checkoutBtns.forEach((btn) => {
    btn.addEventListener("click", async () => {
      const tier = btn.getAttribute("data-tier");
      if (!tier || btn.hasAttribute("disabled")) return;

      try {
        const session = await getCurrentSession();
        const isAuthenticated = !!session;
        const roles = session?.roles || [];
        const targetRole = `surfing-${tier}`;
        const isCurrentPlan = roles.includes(targetRole);
        const ctaText = btn.textContent?.trim() || "";

        // Track CTA click
        trackEvent(PRICING_CTA_CLICKED, {
          tier,
          billingCycle: currentCycle,
          ctaText,
          isAuthenticated,
          isCurrentPlan,
        });

        // If guest
        if (!session) {
          if (tier === "free") {
            await signInRedirect();
          } else {
            sessionStorage.setItem(
              "pendingCheckout",
              JSON.stringify({ tier, billingCycle: currentCycle }),
            );
            await signInRedirect();
          }
          return;
        }

        // Logged in user clicking on a button (that is enabled)
        // If enabled, it means it's NOT their current plan.
        initiateCheckout(tier, currentCycle);
      } catch (error) {
        console.error("Action error:", error);
        alert("Unable to proceed. Please try again.");
      }
    });
  });

  // Checkout Logic
  async function initiateCheckout(tier: string, billingCycle: string) {
    const turnstileApiUrl = import.meta.env.PUBLIC_TURNSTILE_API_URL;
    if (!turnstileApiUrl) {
      alert("Checkout is not yet available.");
      return;
    }

    try {
      const session = await getCurrentSession();
      if (!session) throw new Error("User not authenticated");

      // Get price for tracking
      const priceMap = {
        standard: { monthly: 5, yearly: 50, lifetime: 150 },
        premium: { monthly: 15, yearly: 150, lifetime: 400 },
      };
      const price =
        priceMap[tier as "standard" | "premium"]?.[
          billingCycle as "monthly" | "yearly" | "lifetime"
        ] || 0;

      // Track checkout initiation
      trackEvent(PRICING_CHECKOUT_INITIATED, {
        tier,
        billingCycle,
        price,
        userId: session.user?.id || "unknown",
      });

      const response = await fetch(`${turnstileApiUrl}/api/checkout/session`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${session.accessToken}`,
        },
        body: JSON.stringify({ tier, billingCycle }),
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`API Error (${response.status}): ${errorText}`);
      }
      const { url } = await response.json();
      window.location.href = url;
    } catch (error) {
      console.error("Checkout init error:", error);

      // Track checkout error
      trackEvent(PRICING_CHECKOUT_ERROR, {
        tier,
        billingCycle,
        error: error instanceof Error ? error.message : String(error),
        errorCode:
          error instanceof Error && "code" in error
            ? String(error.code)
            : undefined,
      });

      alert(
        `Unable to start checkout.\n${error instanceof Error ? error.message : String(error)}`,
      );
    }
  }

  // FAQ Tracking
  function setupFaqTracking() {
    const faqDetails = document.querySelectorAll("details");
    faqDetails.forEach((detail, index) => {
      detail.addEventListener("toggle", () => {
        const summary = detail.querySelector("summary");
        const question = summary?.textContent?.trim().slice(0, 50) || "Unknown";

        if (detail.open) {
          trackEvent(PRICING_FAQ_EXPANDED, { question, index });
        } else {
          trackEvent(PRICING_FAQ_COLLAPSED, { question, index });
        }
      });
    });
  }

  // Scroll Depth Tracking
  function setupScrollTracking() {
    const scrollDepths = [25, 50, 75, 100];
    const tracked = new Set<number>();

    function checkScrollDepth() {
      const scrollPercent = Math.round(
        (window.scrollY /
          (document.documentElement.scrollHeight - window.innerHeight)) *
          100,
      );

      for (const depth of scrollDepths) {
        if (scrollPercent >= depth && !tracked.has(depth)) {
          tracked.add(depth);
          trackEvent(PRICING_PAGE_SCROLLED, { depth });
        }
      }
    }

    window.addEventListener("scroll", checkScrollDepth, { passive: true });
  }

  // Initialization
  async function init() {
    // Initialize tracker
    const config = {
      googleAnalyticsId: import.meta.env.PUBLIC_GA_ID || "G-S3D3Q82DSX",
      microsoftClarityId: import.meta.env.PUBLIC_CLARITY_ID || "topkp7sgz2",
      sentryEnabled: true,
      debug: import.meta.env.DEV,
    };
    initTracker(config);

    // Track page view
    const session = await getCurrentSession();
    const isAuthenticated = !!session;
    const roles = session?.roles || [];
    const currentTier = roles
      .find((r) => r.startsWith("surfing-"))
      ?.replace("surfing-", "") as "free" | "standard" | "premium" | undefined;

    trackPageView({
      path: window.location.pathname,
      title: document.title,
      properties: {
        isAuthenticated,
        currentTier,
      },
    });

    trackEvent(PRICING_PAGE_VIEWED, {
      path: window.location.pathname,
      title: document.title,
      isAuthenticated,
      currentTier,
    });

    // Setup tracking
    setupFaqTracking();
    setupScrollTracking();

    // Handle pending checkout
    const pendingCheckout = sessionStorage.getItem("pendingCheckout");
    if (pendingCheckout) {
      getCurrentSession().then((session) => {
        if (session) {
          const { tier, billingCycle } = JSON.parse(pendingCheckout);
          sessionStorage.removeItem("pendingCheckout");
          initiateCheckout(tier, billingCycle);
        }
      });
    }

    updateButtonState();

    onUserLoaded(() => {
      updateButtonState();
    });

    onUserUnloaded(() => {
      window.location.reload();
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }

  document.addEventListener("astro:page-load", () => {
    updateButtonState();
  });
</script>
