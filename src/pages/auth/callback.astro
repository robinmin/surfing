---
/**
 * OIDC Callback Handler
 *
 * This page handles the OAuth2/OIDC callback from Zitadel.
 * It works in both popup mode and redirect mode.
 *
 * Popup mode: Processes tokens and closes the popup, returning control to parent window
 * Redirect mode: Processes tokens and redirects to the home page
 */
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Authenticating...</title>
    <meta name="robots" content="noindex, nofollow" />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .container {
        text-align: center;
        padding: 2rem;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1.5rem;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .message {
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
      }

      .submessage {
        font-size: 0.9rem;
        opacity: 0.8;
      }

      .error {
        background: rgba(255, 0, 0, 0.2);
        border: 1px solid rgba(255, 0, 0, 0.4);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        max-width: 400px;
      }

      .error-title {
        font-weight: bold;
        margin-bottom: 0.5rem;
      }

      .retry-button {
        background: white;
        color: #764ba2;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-size: 1rem;
        cursor: pointer;
        margin-top: 1rem;
        transition: transform 0.2s;
      }

      .retry-button:hover {
        transform: scale(1.05);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="spinner" id="spinner"></div>
      <div class="message" id="message">Completing sign-in...</div>
      <div class="submessage" id="submessage">Please wait while we verify your account</div>
      <div class="error" id="error" style="display: none">
        <div class="error-title">Authentication Error</div>
        <div id="error-text"></div>
        <button class="retry-button" id="retry-button">Try Again</button>
      </div>
    </div>

    <script>
      import { handlePopupCallback, handleRedirectCallback } from '~/lib/turnstile-client';

      const messageEl = document.getElementById('message');
      const submessageEl = document.getElementById('submessage');
      const spinnerEl = document.getElementById('spinner');
      const errorEl = document.getElementById('error');
      const errorTextEl = document.getElementById('error-text');
      const retryButton = document.getElementById('retry-button');

      const showError = (message: string) => {
        if (spinnerEl) spinnerEl.style.display = 'none';
        if (messageEl) messageEl.textContent = 'Sign-in Failed';
        if (submessageEl) submessageEl.style.display = 'none';
        if (errorEl) errorEl.style.display = 'block';
        if (errorTextEl) errorTextEl.textContent = message;
      };

      const showSuccess = () => {
        if (spinnerEl) spinnerEl.style.display = 'none';
        if (messageEl) messageEl.textContent = 'Sign-in Successful!';
        if (submessageEl) submessageEl.textContent = 'Redirecting...';
      };

      // Retry button handler
      retryButton?.addEventListener('click', () => {
        // If we're in a popup, close it and let parent retry
        if (window.opener) {
          window.close();
        } else {
          // In redirect mode, go back to home
          window.location.href = '/';
        }
      });

      // Determine if we're in a popup or redirect flow
      const isPopup = window.opener !== null;

      const processCallback = async () => {
        try {
          if (isPopup) {
            // Popup mode: process callback and close
            await handlePopupCallback();
            // The popup will be closed automatically by oidc-client-ts
            // If not, close it manually after a short delay
            setTimeout(() => {
              if (!window.closed) {
                window.close();
              }
            }, 1000);
          } else {
            // Redirect mode: process callback and redirect
            await handleRedirectCallback();
            showSuccess();
            // Redirect to home page after successful auth
            setTimeout(() => {
              window.location.href = '/';
            }, 1500);
          }
        } catch (error) {
          console.error('Auth callback error:', error);

          let errorMessage = 'An unexpected error occurred during sign-in.';

          if (error instanceof Error) {
            if (error.message.includes('access_denied')) {
              errorMessage = 'Access was denied. You may have cancelled the sign-in.';
            } else if (error.message.includes('invalid_grant')) {
              errorMessage = 'The authentication session has expired. Please try again.';
            } else if (error.message.includes('invalid_request')) {
              errorMessage = 'Invalid authentication request. Please try again.';
            } else {
              errorMessage = error.message;
            }
          }

          showError(errorMessage);

          // In popup mode, notify parent about error
          if (isPopup && window.opener) {
            try {
              window.opener.postMessage(
                {
                  type: 'auth_error',
                  error: errorMessage,
                },
                window.location.origin
              );
            } catch {
              // Parent window might be closed or different origin
            }
          }
        }
      };

      // Start processing immediately
      processCallback();
    </script>
  </body>
</html>
